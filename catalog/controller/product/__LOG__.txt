
      WITH
        tmpProductType1 AS (
          SELECT
              1 AS type, 0 AS level, pr.ord, p.product_id
            FROM product_relative pr
            LEFT JOIN oc_product p ON p.product_id = pr.relative_product_id
            WHERE pr.product_id = 9600
              AND p.quantity + p.quantity_store_2
            GROUP BY p.product_id
        ),
        tmpProductType2 AS (
          SELECT
            2 AS type, cp.level, cpr.ord, p.product_id
          FROM oc_product_to_category ptc
          LEFT JOIN oc_category_path cp ON cp.category_id = ptc.category_id
          LEFT JOIN category_product_relative cpr ON cpr.category_id = cp.path_id
          INNER JOIN oc_product p ON p.product_id = cpr.relative_product_id
          WHERE ptc.product_id = 9600
            AND ptc.product_id NOT IN (SELECT product_id FROM tmpProductType1)
            AND p.quantity + p.quantity_store_2
          
        ),
        tmpCategory AS (
          SELECT category_id FROM oc_product_to_category
          WHERE product_id = 9600 LIMIT 1
        ),
        tmpProductType3 AS (
          SELECT 3 AS type, 0 AS level, COALESCE(cr.ord, 9999999) AS ord, p.product_id
          FROM products_models pm
          LEFT JOIN oc_product p ON p.product_id = pm.product_id
          LEFT JOIN oc_product_to_category ptc ON ptc.product_id = p.product_id
          LEFT JOIN (
            SELECT relative_category_id, ord FROM category_relative
            WHERE category_id = (SELECT * FROM tmpCategory)
          ) cr ON cr.relative_category_id = ptc.category_id
          WHERE
            pm.model_id IN (SELECT model_id FROM products_models WHERE product_id = 9600)
            AND ptc.category_id != (SELECT * FROM tmpCategory)
            AND ptc.product_id NOT IN (
              SELECT product_id FROM tmpProductType1
              UNION
              SELECT product_id FROM tmpProductType2
            )
            AND p.quantity + p.quantity_store_2
          GROUP BY pm.product_id
        ),
        tmpProductsUnion AS (
          SELECT * FROM tmpProductType1
          UNION ALL
          SELECT * FROM tmpProductType2
          UNION ALL
          SELECT * FROM tmpProductType3
          ORDER BY type, level DESC, ord
          LIMIT 30
        ),
        tmpProducts AS (
          SELECT
            p.product_id,
            pd.name,
            COALESCE(
              (SELECT price
                FROM oc_product_special
                WHERE product_id = p.product_id
                  AND customer_group_id = 1
                  AND (date_start = '0000-00-00' OR date_start < NOW())
                  AND (date_end = '0000-00-00' OR date_end > NOW())
                ORDER BY priority ASC, price ASC LIMIT 1),
              pdc.price,
              p.price) AS price,
            IF(p.image = '',
              COALESCE(
                (SELECT image FROM oc_product_image
                  WHERE product_id = p.product_id ORDER BY sort_order LIMIT 1),
                'placeholder.png'
              ), p.image) AS image
          FROM tmpProductsUnion tp
          LEFT JOIN oc_product p on p.product_id = tp.product_id
          LEFT JOIN oc_product_description pd ON pd.product_id = p.product_id
          LEFT JOIN oc_product_discount pdc ON pdc.product_id = p.product_id
                AND pdc.customer_group_id = 1
        )
      SELECT
        p.product_id AS productId,
        p.name,
        p.image,
        p.price AS priceUSD,
        ROUND(p.price * c.value) AS priceUAH
      FROM tmpProducts p
      LEFT JOIN oc_currency c ON c.currency_id = 980
