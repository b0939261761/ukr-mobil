const siteLoader = document.getElementById('siteLoader');

const showSiteLoader = () => {
  siteLoader.classList.remove('hide');
  document.body.classList.add('body-site-loader');
}

const hideSiteLoader = () => {
  siteLoader.classList.add('hide');
  document.body.classList.remove('body-site-loader');
}

window.addEventListener('load', () => {
  const downloadPriceList = document.querySelector('.download-price-list a');

  const getFileName = (contentDisposition = '') => {
    const filenameMatch = contentDisposition.match(/filename[^;\n=]*=((['"])(.*)?\2|[^;\n]*)/);
    return (filenameMatch && filenameMatch[3]) || 'price-list.xls';
  }

  const onClick = async event => {
    event.preventDefault();
    const wrapperPreloader = document.querySelector('.wrapper-preloader');
    wrapperPreloader.classList.add('preloader-appear');
    const response = await fetch('/price-list');
    const blob = await response.blob();

    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = getFileName(response.headers.get('content-disposition'));
    document.body.appendChild(a);
    a.click();
    a.remove();
    wrapperPreloader.classList.remove('preloader-appear');
  };

  downloadPriceList.addEventListener('click', onClick);

  hideSiteLoader();
});

window.addEventListener('load', function() {
	function HoverWatcher(selector) {
		this.hovering = false;
		var self = this;

		this.isHoveringOver = function () {
			return self.hovering;
		}

		$(selector).hover(function () {
			self.hovering = true;
		}, function () {
			self.hovering = false;
		})
	}

	function LangCurDropDown(selector, subsel) {
		var main_block = new HoverWatcher(selector);
		var sub_ul = new HoverWatcher(subsel);
		$(selector).click(function () {
			$(selector).addClass('active');
			$(subsel).slideToggle('slow');
			setTimeout(function () {
				if (!main_block.isHoveringOver() && !sub_ul.isHoveringOver())
					$(subsel).stop(true, true).slideUp(450);
				$(selector).removeClass('active');
			}, 3000);
		});

		$(subsel).hover(function () {
			setTimeout(function () {
				if (!main_block.isHoveringOver() && !sub_ul.isHoveringOver())
					$(subsel).stop(true, true).slideUp(450);
			}, 3000);
		});
	}

  LangCurDropDown('#cart', '.cart-menu');
  window.uiService = { popup: new EgoProximaPopup() };
  (new CallbackComponent({elementRef: null})).init();

  $('body').on('click', '.to-wishlist, #btnSubscribeWishlist', function (e) {
    var target = $(e.target).closest('.to-wishlist');
    var productId = parseInt(target.attr('data-product-id'));

    _request({
      url: 'index.php?route=product/product/addToWishlist',
      data: {
        transferData: {
          productId: productId
        }
      },
      success: function (response) {
        //	Only authorized users
        if (response.code === 401) {
          window.uiService.popup
            .setHeader('Ошибка')
            .setBody('\
              <div class="add-to-wishlist">\
                <div class="add-to-wishlist__message">\
                  ' + 'Только авторизированные пользователи могут делать данную операцию.' + '\
                </div>\
                <div class="login-or-register">\
                  <div>\
                    <a href="/index.php?route=account/login">\
                      ' + 'Войти' + '\
                    </a>\
                  </div>\
                  <div>\
                    <a href="/index.php?route=account/register">\
                      ' + 'Регистрация' + '\
                    </a>\
                  </div>\
                </div>\
              </div>\
            ')
            .hideFooter()
            .open();

          return;
        }

        //	Another errors
        if (response.code !== 200) {
          console.error(response.message);
          return;
        }

        //	Notify user about success
        window.uiService.popup
          .setHeader('Информация')
          .setBody('Продукт добавлен! Мы известим Вас как только он появится у нас!')
          .hideFooter()
          .open();

        //	Remove button
        target.remove();
      }
    });
  });

  $('body').on('keydown keyup', '.restrict-language', function (e) {
    var eTarget = $(e.target);
    eTarget.val(eTarget.val().replace(/[^абвгдеёжзийклмнопрстуфхцчшщъыьэюяіїґє\- 0-9]/ig, ''));
  });

  $("body").append("<a class='top_button' title='Back To Top' href=''>TOP</a>");

	$(function () {
		$(window).scroll(function () {
			if ($(this).scrollTop() > 70) {
				$('.top_button').fadeIn();
			} else {
				$('.top_button').fadeOut();
			}
		});
		// scroll body to 0px on click
		$('.top_button').click(function () {
			$('body,html').animate({
				scrollTop: 0
			}, 800);
			return false;
		});
  });
});

