const btnSubtract = document.getElementById('btnSubtract');
const btnAdd = document.getElementById('btnAdd');
const inpAmount = document.querySelector('.product-amount__input');

const onClickBtnAdd = () => {
  inpAmount.value = ++inpAmount.value;
  if (+inpAmount.value > +inpAmount.min) btnSubtract.disabled = false;
}

btnAdd.addEventListener('click', onClickBtnAdd);

const onClickBtnSubtract = () => {
  inpAmount.value = --inpAmount.value;
  if (+inpAmount.value <= +inpAmount.min) btnSubtract.disabled = true;
}

btnSubtract.addEventListener('click', onClickBtnSubtract);

//---------------------------------------------------------------

const body = document.querySelector('body');

const onClickInfoButton = event => {
  body.classList.add('modal-open');
  const modal = document.getElementById(event.target.dataset.modalId);
  modal.classList.add('wrapper-form-modal--open');
};

const infoButtons = document.querySelectorAll('.info-button');
infoButtons.forEach(el => el.addEventListener('click', onClickInfoButton));

const onClickFormModalBtnCloses = event => {
  if (event.target !== event.currentTarget) return;
  body.classList.remove('modal-open');
  const modal = event.target.classList.contains('wrapper-form-modal')
    ? event.target
    : event.target.closest('.wrapper-form-modal');
  modal.classList.remove('wrapper-form-modal--open');
};

const formModalBtnCloses = document.querySelectorAll('.form-modal__btn-close, .wrapper-form-modal');
formModalBtnCloses.forEach(el => el.addEventListener('click', onClickFormModalBtnCloses));

//---------------------------------------------------------------

const productGallery = document.getElementById('productGallery');
lightGallery(productGallery);

productGallery.addEventListener('onBeforeSlide', event => {
  const index = event.detail.index + 1;
  const item = productGallery.querySelector(`.product__gallery-item:nth-child(${index})`);
  productPreview.dataset.lgIndex = index;
  productPreview.src = item.dataset.preview;
});

const onClickProductPreview = evt => {
  productGallery
    .querySelector(`.product__gallery-item:nth-child(${evt.target.dataset.lgIndex})`)
    .click();
}

const productPreview = document.querySelector('.product__preview')
productPreview.addEventListener('click', onClickProductPreview);

//---------------------------------------------------------------

const onAddCart = (productId, quantity) => {
  $.ajax({
    url: '/index.php?route=common/cart/add',
    type: 'post',
    data: {
      product_id: productId,
      quantity
    },
    dataType: 'json',
    success: function (json) {
      $('.alert-dismissible, .text-danger').remove();
      $('.form-group').removeClass('has-error');

      if (json['error']) {
        $.notifyClose();
        $.notify({
          message: json['error'],
          target: '_blank'
        }, {
          // settings
          element: 'body',
          position: null,
          type: "info",
          allow_dismiss: true,
          newest_on_top: true,
          placement: {
            from: "top",
            align: "center"
          },
          offset: 0,
          spacing: 10,
          z_index: 2031,
          delay: 5000,
          timer: 1000,
          url_target: '_blank',
          mouse_over: null,
          animate: {
            enter: 'animated fadeInDown',
            exit: 'animated fadeOutUp'
          },
          onShow: null,
          onShown: null,
          onClose: null,
          onClosed: null,
          icon_type: 'class',
          template: '<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-error" role="alert">' +
          '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">&nbsp;&times;</button>' +
          '<span data-notify="message"><i class="fa fa-check-circle"></i>&nbsp; {2}</span>' +
          '<div class="progress" data-notify="progressbar">' +
          '<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
          '</div>' +
          '<a href="{3}" target="{4}" data-notify="url"></a>' +
          '</div>'
        });
      }

      if (json['success']) {
        $.notifyClose();
        $.notify({
          message: json['success'],
          target: '_blank'
        }, {
          // settings
          element: 'body',
          position: null,
          type: "info",
          allow_dismiss: true,
          newest_on_top: true,
          placement: {
            from: "top",
            align: "center"
          },
          offset: 0,
          spacing: 10,
          z_index: 2031,
          delay: 5000,
          timer: 1000,
          url_target: '_blank',
          mouse_over: null,
          animate: {
            enter: 'animated fadeInDown',
            exit: 'animated fadeOutUp'
          },
          onShow: null,
          onShown: null,
          onClose: null,
          onClosed: null,
          icon_type: 'class',
          template: '<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-success" role="alert">' +
          '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">&nbsp;&times;</button>' +
          '<span data-notify="message"><i class="fa fa-check-circle"></i>&nbsp; {2}</span>' +
          '<div class="progress" data-notify="progressbar">' +
          '<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
          '</div>' +
          '<a href="{3}" target="{4}" data-notify="url"></a>' +
          '</div>'
        });

        $('#cart > button').html('<i class="fa fa-shopping-cart"></i><span id="cart-total"> ' + json['total'] + '</span>');
        $('#cart > ul').load('/index.php?route=common/cart/info ul li');
      }
    },
    error: function (xhr, ajaxOptions, thrownError) {
      alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
    }
  });
}

const productId = document.getElementById('productId').textContent;
const productAmount = document.querySelector('.product-amount__input');

const buttonCart = document.getElementById('button-cart')
if (buttonCart) {
  buttonCart.addEventListener('click', () => onAddCart(productId, productAmount.value));
}

// -------------------------------------------------

const relativeProductBtnBuyList = document.querySelectorAll('.relative-product__btn-buy');
relativeProductBtnBuyList.forEach(
  el => el.addEventListener('click', evt => onAddCart(evt.target.dataset.productId, 1))
);

window.addEventListener('load', function () {
  $('[data-toggle=\'tooltip\']').tooltip({container: 'body'});

  new Splide( '.splide', {
    perPage: 1,
    fixedWidth: '200px',
    gap: '20px',
    pagination: false,
    classes: {
      arrow: 'splide__arrow splide__arrow--modify',
      prev: 'splide__arrow--prev splide__arrow--prev-modify',
      next: 'splide__arrow--next splide__arrow--next-modify',
    }
  }).mount();

  const onClickReviewPagination = async evt => {
    if (!evt.target.tagName === 'A'
      || !evt.target.parentElement.parentElement.classList.contains('pagination')) return;
    evt.preventDefault();
    const response = await fetch(evt.target.href);
    reviews.innerHTML = await response.text();
  }

  const reviews = document.getElementById('reviews');
  reviews.addEventListener('click', onClickReviewPagination);

  // -------------------------------------------------

  const onSendReview = async evt => {
    evt.preventDefault();

    const url = '/index.php?route=product/product/reviewAdd';

    const name = document.getElementById('reviewName');
    const text = document.getElementById('reviewText');
    const rating = document.querySelector('input[name="rating"]:checked');

    const body = JSON.stringify({
      productId,
      name: name.value,
      text: text.value,
      rating: rating.value
    });

    await fetch(url, { method: 'POST', body });

    text.value = '';
    rating.checked = false;

    const reviewSuccess = document.getElementById('reviewSuccess');
    reviewSuccess.classList.remove('hide');
    reviewSuccess.scrollIntoView({ behavior: 'smooth' });
  }

  const formReview = document.getElementById('formReview');
  formReview.addEventListener('submit', onSendReview);

  // -------------------------------------------------

  var owl = $('.related-carousel').owlCarousel({
    loop: true,
    margin: 10,
    nav: false,
    responsive: {
      0: { items: 1 },
      600: { items: 3 },
      1000: { items: 5 }
    }
  });

  $('body').find('.nav.prev').click(function () {
    owl.trigger('prev.owl.carousel');
  });

  $('body').find('.nav.next').click(function () {
    owl.trigger('next.owl.carousel');
  });
});
