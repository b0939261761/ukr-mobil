const btnSubtract = document.getElementById('btnSubtract');
const btnAdd = document.getElementById('btnAdd');
const inpAmount = document.querySelector('.product-amount__input');

const onClickBtnAdd = () => {
  inpAmount.value = ++inpAmount.value;
  if (+inpAmount.value > +inpAmount.min) btnSubtract.disabled = false;
}

btnAdd.addEventListener('click', onClickBtnAdd);

const onClickBtnSubtract = () => {
  inpAmount.value = --inpAmount.value;
  if (+inpAmount.value <= +inpAmount.min) btnSubtract.disabled = true;
}

btnSubtract.addEventListener('click', onClickBtnSubtract);

//---------------------------------------------------------------

const body = document.querySelector('body');

const onClickInfoButton = event => {
  body.classList.add('modal-open');
  const modal = document.getElementById(event.target.dataset.modalId);
  modal.classList.add('wrapper-form-modal--open');
};

const infoButtons = document.querySelectorAll('.info-button');
infoButtons.forEach(el => el.addEventListener('click', onClickInfoButton));

const onClickFormModalBtnCloses = event => {
  if (event.target !== event.currentTarget) return;
  body.classList.remove('modal-open');
  const modal = event.target.classList.contains('wrapper-form-modal')
    ? event.target
    : event.target.closest('.wrapper-form-modal');
  modal.classList.remove('wrapper-form-modal--open');
};

const formModalBtnCloses = document.querySelectorAll('.form-modal__btn-close, .wrapper-form-modal');
formModalBtnCloses.forEach(el => el.addEventListener('click', onClickFormModalBtnCloses));

//---------------------------------------------------------------

const productIdValue = +document.getElementById('productId').textContent;

window.addEventListener('load', function () {
  $('[data-toggle=\'tooltip\']').tooltip({container: 'body'});

  $('#button-cart').on('click', function () {
    $.ajax({
      url: 'index.php?route=checkout/cart/add',
      type: 'post',
      data: {
        product_id: productIdValue,
        quantity: $('.product-amount__input').val()
      },
      dataType: 'json',
      beforeSend: function () {
        $('#button-cart').button('loading');
      },
      complete: function () {
        $('#button-cart').button('reset');
      },
      success: function (json) {
        $('.alert-dismissible, .text-danger').remove();
        $('.form-group').removeClass('has-error');

        if (json['error']) {
          $.notifyClose();
          $.notify({
            message: json['error'],
            target: '_blank'
          }, {
            // settings
            element: 'body',
            position: null,
            type: "info",
            allow_dismiss: true,
            newest_on_top: true,
            placement: {
              from: "top",
              align: "center"
            },
            offset: 0,
            spacing: 10,
            z_index: 2031,
            delay: 5000,
            timer: 1000,
            url_target: '_blank',
            mouse_over: null,
            animate: {
              enter: 'animated fadeInDown',
              exit: 'animated fadeOutUp'
            },
            onShow: null,
            onShown: null,
            onClose: null,
            onClosed: null,
            icon_type: 'class',
            template: '<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-error" role="alert">' +
            '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">&nbsp;&times;</button>' +
            '<span data-notify="message"><i class="fa fa-check-circle"></i>&nbsp; {2}</span>' +
            '<div class="progress" data-notify="progressbar">' +
            '<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
            '</div>' +
            '<a href="{3}" target="{4}" data-notify="url"></a>' +
            '</div>'
          });

          $('#cart > button').html('<i class="fa fa-shopping-cart"></i><span id="cart-total"> ' + json['total'] + '</span>');
          $('#cart > ul').load('index.php?route=common/cart/info ul li');
        }

        if (json['success']) {
          $.notifyClose();
          $.notify({
            message: json['success'],
            target: '_blank'
          }, {
            // settings
            element: 'body',
            position: null,
            type: "info",
            allow_dismiss: true,
            newest_on_top: true,
            placement: {
              from: "top",
              align: "center"
            },
            offset: 0,
            spacing: 10,
            z_index: 2031,
            delay: 5000,
            timer: 1000,
            url_target: '_blank',
            mouse_over: null,
            animate: {
              enter: 'animated fadeInDown',
              exit: 'animated fadeOutUp'
            },
            onShow: null,
            onShown: null,
            onClose: null,
            onClosed: null,
            icon_type: 'class',
            template: '<div data-notify="container" class="col-xs-11 col-sm-3 alert alert-success" role="alert">' +
            '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">&nbsp;&times;</button>' +
            '<span data-notify="message"><i class="fa fa-check-circle"></i>&nbsp; {2}</span>' +
            '<div class="progress" data-notify="progressbar">' +
            '<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
            '</div>' +
            '<a href="{3}" target="{4}" data-notify="url"></a>' +
            '</div>'
          });

          $('#cart > button').html('<i class="fa fa-shopping-cart"></i><span id="cart-total"> ' + json['total'] + '</span>');
          $('#cart > ul').load('index.php?route=common/cart/info ul li');
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    });
  });


  $('#review').delegate('.pagination a', 'click', function (e) {
    e.preventDefault();
    $('#review').fadeOut('slow');
    $('#review').load(this.href);
    $('#review').fadeIn('slow');
  });

  $('#review').load(`index.php?route=product/product/review&product_id=${productIdValue}`);

  $('#button-review').on('click', function () {
		$.ajax({
			url: `index.php?route=product/product/write&product_id=${productIdValue}`,
			type: 'post',
			dataType: 'json',
			data: $("#form-review").serialize(),
			beforeSend: function () {
				$('#button-review').button('loading');
			},
			complete: function () {
				$('#button-review').button('reset');
			},
			success: function (json) {
				$('.alert-dismissible').remove();

				if (json['error']) {
					$('#review').after('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + '</div>');
				}

				if (json['success']) {
					$('#review').after('<div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> ' + json['success'] + '</div>');

					$('input[name=\'name\']').val('');
					$('textarea[name=\'text\']').val('');
					$('input[name=\'rating\']:checked').prop('checked', false);
				}
			}
		});
	});

  var eGallery = $('#lightgallery');

  //	Select thumbs. By click on it show big image
  var eThumbs = $('.thumbs');
  eThumbs.on('click', '.item', function (e) {
    var eItem = $(e.target).closest('.item');
    var ePreview = $('.images .preview div');

    ePreview
      .attr('data-current-position', eItem.index())
      .css('backgroundImage', 'url(' + eItem.find('div').attr('data-image') + ')');
  });

  // Gallery
  eGallery.lightGallery();

  $('.preview').on('click', function (e) {
    var ePreview = $(e.target).closest('.preview div');
    var currentPosition = parseInt(ePreview.attr('data-current-position'));

    if (!(currentPosition >= 0)) {
      currentPosition = 0;
    }

    eThumbs.find('.item').eq(currentPosition).trigger('click');
  });

  var owl = $('.related-carousel').owlCarousel({
    loop: true,
    margin: 10,
    nav: false,
    responsive: {
      0: { items: 1 },
      600: { items: 3 },
      1000: { items: 5 }
    }
  });

  $('body').find('.nav.prev').click(function () {
    owl.trigger('prev.owl.carousel');
  });

  $('body').find('.nav.next').click(function () {
    owl.trigger('next.owl.carousel');
  });
});
