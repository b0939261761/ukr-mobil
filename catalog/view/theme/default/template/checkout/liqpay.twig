{{ header }}

<style>
  body {
    margin: 0;
  }
</style>

<form
  id="formLiqpay"
  method="POST"
  action="https://www.liqpay.ua/api/3/checkout"
  target="frameLiqpay"
>
  <input
    type="hidden"
    name="data"
    value="{{ liqpayPayload.data }}"
  />

  <input
    type="hidden"
    name="signature"
    value="{{ liqpayPayload.signature }}"
  />
</form>

<iframe name="frameLiqpay" allowfullscreen frameBorder="0" width="100%" height="600"></iframe>

<script>
  (() => {
    const domain = `${window.location.protocol}//${window.location.hostname}`;
    const urlCheckSuccess = new URL(`${domain}/index.php`);
    urlCheckSuccess.searchParams.set('route', 'checkout/liqpay/checkSuccess');
    const urlCheckoutSuccess = new URL(`${domain}/index.php`);
    urlCheckoutSuccess.searchParams.set('route', 'checkout/success');

    const search = new URLSearchParams(window.location.search)
    for (let i = 0; i < 2; ++i) {
      const name = `orders[${i}]`;
      const order = search.get(name);
      if (order) {
        urlCheckSuccess.searchParams.set(name, order);
        urlCheckoutSuccess.searchParams.set(name, order);
      }
    }

    const checkSuccess = async () => {
      try {
        const response = await fetch(urlCheckSuccess.toString());
        if (response.ok) {
          const result = await response.text()
          console.log(result);
          if (result) return window.location = urlCheckoutSuccess.toString();
        }
      } catch (err) {
        console.error(err);
      }
      setTimeout(checkSuccess, 1000);
    };

    const formLiqpay = document.getElementById('formLiqpay');
    formLiqpay.submit();
    setTimeout(checkSuccess, 5000);
  })();
</script>

{{ footer }}
